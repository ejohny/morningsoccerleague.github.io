
<html>
<header>

  <title>Morning Soccer League</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/team.css">
  <script src="js/prefixfree.min.js"></script>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta charset="utf-8">
  <META HTTP-EQUIV="Pragma" CONTENT="no-cache">
  <META HTTP-EQUIV="Expires" CONTENT="-1">

  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1" />
  <meta name="apple-mobile-web-app-title" content="Hub"/>
  <meta name="theme-color" content="#006efc">
  <meta name="apple-mobile-web-app-status-bar-style" content="black"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.8/handlebars.min.js"></script>
</header>
<body>

<script id="schedule-template" type="text/x-handlebars-template">
  {{#each this}}
    <tr>
        <th  scope="row" class="event-week">{{@index}}</th>
        <td class="event-week">{{scheduled_date}}</td>
        <td class="home-team-cls">
          <table width="100%">
            <tr>
              <td class="{{home_team.teamCls}}">
                <img  src="images/{{home_team.id}}.png" />
                <strong>{{home_team.teamName}}</strong>
              </td>
            </tr>
            {{#if stats.home}}
            <tr>
              <td class="text-right team-score score-sep">{{stats.home.goals.length}}</td>
            </tr>
            {{/if}}
            <tr>
              <td>

                <ul class="goals-section">
                  {{#each home_goals}}
                    <li class="goal-cls">{{player.name}}<strong>{{minute}}"</strong></li>
                  {{/each}}
                </ul>

              </td>
            </tr>
            <tr>
              <td>

                <ul class="caution-cls">
                  {{#each home_cautions}}
                  <li class="{{card.cls}} ">{{player.name}} <strong>{{minute}}"</strong></li>
                  {{/each}}
                </ul>

              </td>
            </tr>

          </table>
        </td>
        <td class="away-team-cls">
          <table width="100%">
            <tr>
              <td class="{{away_team.teamCls}} text-right">
                <strong>{{away_team.teamName}}</strong>
                <img  src="images/{{away_team.id}}.png" />

              </td>
            </tr>
            {{#if stats.away}}
            <tr>
              <td class="text-left team-score">{{stats.away.goals.length}}</td>
            </tr>
            {{/if}}
            <tr>
              <td>

                <ul class="goal-section">
                  {{#each away_goals}}
                  <li class="goal-cls text-right">{{player.name}} <strong>{{minute}}"</strong></li>
                  {{/each}}
                </ul>

              </td>
            </tr>
            <tr>
              <td>

                <ul class="caution-cls">
                  {{#each away_cautions}}
                  <li class="{{card.cls}} text-right">{{player.name}}, <strong>{{minute}}"</strong></li>
                  {{/each}}
                </ul>

              </td>
            </tr>
          </table>
          </strong></td>
        <td>
          {{#each referee_team}}
                <strong class="{{teamCls}}">{{teamName}}</strong>
                {{#if @index}} {{else}} &  {{/if}}
          {{/each}}
        </td>
    </tr>
  {{/each}}
</script>



<header>
  <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="#featured">
          <img src="images/msl2.svg" class="big-logo" />
          <img src="images/msl_logo.svg" class="small-logo" />
        </a>
      </div><!-- navbar-header -->
      <div class="collapse navbar-collapse" id="collapse">
        <ul class="nav navbar-nav navbar-right">
          <li ><a href="index.html#featured">Home</a></li>
          <li ><a href="stats.html">Stats</a></li>
          <li class="active"><a href="schedule.html">Schedule</a></li>
          <li><a href="index.html#mission">Mission</a></li>
          <li><a href="index.html#teams">Tournament</a></li>
          <li><a href="registration.html">Register</a></li>
          <li><a href="rules.html">Rules</a></li>
          <li><a href="index.html#staff">Contacts</a></li>
        </ul>
      </div><!-- collapse navbar-collapse -->
    </div><!-- container  -->
  </nav>
</header>
<div class="container">
  <div class="table-responsive">
    <table class="table table-bordered table-striped">
      <thead>
      <tr class="team-table-header">
        <th style="width: 60px;">Week</th>
        <th style="width: 100px;">Date</th>
        <th style="width: 300px;">Home Team</th>
        <th style="width: 300px;">Away Team</th>
        <th style="width: 280px;">Referee Team</th>
      </tr>
      </thead>
      <tbody>

      </tbody>
    </table>
  </div>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script src="js/myscript.js"></script>
<script>

  var datetime = Math.round(new Date().getTime() / 1000);

  var players = [];
  var cautions = [];
  var playerobj = {};
  var cautionobj = {};

  loadPlayers();
  loadCautions();

  $(document).ready(function () {

    loadTeams(loadSchedule)


  });

  function getTeamName (teamsArr, teamId) {
    return _.where(teamsArr,{id : teamId})[0];
  }


  function getCautions (stats) {
    var cautions = []
    if(stats.cautions) {
      cautions = _.map(stats.cautions, function(item){
          return {
             player : playerobj[item['player']][0],
             card   : cautionobj[item['caution_id']][0],
             minute : item.minute
          }
      })
    }
    return cautions;
  }

  function getGoals (stats) {
    var goals = []
    if(stats.goals) {
      goals = _.map(stats.goals, function(item){
        return {
          player : playerobj[item['player']][0],
          minute : item.minute
        }
      })
    }
    return goals;
  }

  function  loadTeams (callback){
    $.getJSON('./data/teams.json?time='+datetime,function(json){
        callback(json)
    });
  }
  function  loadPlayers (){
    $.getJSON('./data/players.json?time='+datetime,function(json){
      players = json;
    });
  }

  function  loadCautions (){
    $.getJSON('./data/caution.json?time='+datetime,function(json){
      cautions = json;
    });
  }

  function buildTableData (teamsArr, scheduleArr){

    playerobj = _.groupBy(players,function (o) {
              return o.id;
            });
    cautionobj = _.groupBy(cautions,function (o) {
              return o.id;
            });
    var scheduleArrFormatted = [];
    _.each(scheduleArr,function(item, index){
      var newItem = JSON.parse(JSON.stringify(item));

      var ref_team1 = getTeamName(teamsArr, item.referee_team[0]);
      var ref_team2 = getTeamName(teamsArr, item.referee_team[1]);


      newItem.home_team =  getTeamName(teamsArr, item.home_team);
      newItem.away_team =  getTeamName(teamsArr, item.away_team);
      newItem.referee_team = [ref_team1,ref_team2];
      newItem.home_cautions = (item.stats) ? getCautions(item.stats.home) : [];
      newItem.away_cautions = (item.stats) ?  getCautions(item.stats.away) : [];

      newItem.home_goals = (item.stats) ? getGoals(item.stats.home) : [];
      newItem.away_goals = (item.stats) ?  getGoals(item.stats.away) : [];

      console.log(newItem,'0---------------')
      scheduleArrFormatted.push(newItem)
    });

    return scheduleArrFormatted;

  }

  function  renderTable (scheduleData){

    var schedule_source   = $("#schedule-template").html();
    var schedule_template = Handlebars.compile(schedule_source);


    var schedule_html    = schedule_template(scheduleData);
    $('tbody').html(schedule_html);

  }
  function  loadSchedule(teamsArr){
    $.getJSON('./data/schedule.json?time='+datetime,function(json){
        var scheduleData = buildTableData(teamsArr, json);
        renderTable(scheduleData);
    });

  }
</script>
</body>
</html>
